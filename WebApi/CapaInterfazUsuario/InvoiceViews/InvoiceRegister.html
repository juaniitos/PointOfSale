<!DOCTYPE html>
    <head>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    
    <!-- Conexión a JQUERY, BOOTSTRAP y POPPER.JS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous">
    </script>
    </head>
    <body>
        <div class="container">
            <div class="row align-items-start" style="padding: 0; font-size: 10px ">
                <div class="col-md-1">
                    <div class="row align-items-start">
                        <div class="col">
                            <figure class="figure">
                                <img src="../InvoiceViews/Images/Logo.jpg" class="figure figure-img img-fluid rounded" alt="...">
                            </figure>
                        </div>
                    </div>
                </div>
                <div class="col" style="padding:0px">
                    <p>Sistema Web S.A. de C.V.</p>
                    <p>234/90, New YorkStreet</p>
                    <p>United States.</p>
                </div>
                <div class="col" style="padding:0px">
                    <p>Web: www.sistemasweb.la</p>
                    <p>E-mail: info@obedalvarado.pw</p>
                    <p>Tel: +456-345-908-559</p>
                    <p>Twitter: alvarado_obed</p>
                </div>
                <div class="col" style="padding:0px">
                    <p>Datos Bacarios:</p>
                    <p>Titular de la cuenta:</p>
                    <p>IBAN:</p>
                    <p>BIC:</p>
                </div>
            </div>
        </div>
        <hr />
        <div class="container">
            <div class="row align-items-lg-start">
                <div class="col">
                    <h2>Factura</h2>
                </div>
                <div class="col" style="text-align:end">
                    <div class="row">
                        <div class="col">
                            <p>Fecha:</p>
                            <p>Factura #</p>
                            <p>Vence:</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3" style="text-align:end">
                    <div class="row">
                        <div class="col">
                            <input type="date" class="form-control" id="fechaRegistro" placeholder="" readonly>
                            <input type="text" class="form-control" id="idCabecera" placeholder="" readonly>
                            <input type="date" class="form-control" id="Vencimiento" name="Vencimiento" placeholder="" required/>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="container">

            <div class="row align-items-lg-start">
                <div class="col"></div>
                <div class="col" style="text-align:end">
                    <div class="row"></div>
                    <div class="col">
                    </div>
                </div>
                <div class="col-md-3" style="text-align:end">
                    <div class="row">
                        <div class="col">
                        </div>
                    </div>
                </div>
        
            </div>
            <div class="row align-items-start">
                <div class="col">
                    <h6>Factura a</h6>
                    <input type="text" class="form-control" id="NombreCliente" placeholder="Ingrese su Nombre" required>
                    <input type="text" class="form-control" id="NombreEmpresa" placeholder="Ingrese su Nombre de Empresa" required>
                    <input type="text" class="form-control" id="DireccionEmpresa" placeholder="Ingrese Direccion de Empresa" required>
                    <input type="text" class="form-control" id="TelEmpresa" placeholder="Ingrese Telefono de Empresa" required>
                </div>
                <div class="col">
                    <h6>Enviar a</h6>
                    <input type="text" class="form-control" id="NombreClienteEnvio" placeholder="Ingrese su Nombre" required>
                    <input type="text" class="form-control" id="NombreEmpresaEnvio" placeholder="Ingrese su Nombre de Empresa" required>
                    <input type="text" class="form-control" id="DireccionEmpresaEnvio" placeholder="Ingrese Direccion de Empresa" required>
                    <input type="text" class="form-control" id="TelEmpresaEnvio" placeholder="Ingrese Telefono de Empresa" required>
                </div>
            </div>
        </div>
            <table class="container table-bordered">
                <thead style="align-items: center; align-content: center;">
                    <tr>
                        <th>Vendedor</th>
                        <th>Orden de Compra</th>
                        <th>Enviar por</th>
                        <th>Terminos y condiciones</th>
                    </tr>
                </thead>
                <tbody>
                    <td><input type="text" class="form-control" id="NombreVendedor" placeholder="Ingrese Nombre de Vendedor" required></td>
                    <td><input type="text" class="form-control" id="OrdenCompra" placeholder="Ingrese No. Orden de Compra" required></td>
                    <td><input type="text" class="form-control" id="EnviarPor" placeholder="Ingrese Metodo de Envio" required></td>
                    <td><input type="text" class="form-control" id="TerminosCondiciones" placeholder="Ingrese Forma de Pago" required></td>
                </tbody>
            </table>
            <table class="table table-hover table-sm text-center" id="tabla-detalle">
                <thead>
                    <tr class="text-center">
                        <th scope="col">Codigo</th>
                        <th scope="col">Descripcion</th>
                        <th scope="col">Cantidad</th>
                        <th scope="col">Precio</th>
                        <th scope="col">Total</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="text-center fila-detalle">
                        <td>
                            <select id="producto" name="Detalles[0].CodigoProducto" class="form-control producto">
                                <option value="">Seleccione un producto</option>
                            </select>
                        </td>
                        <td><input id="descripcion" name="Detalles[0].DescripcionProducto" placeholder="" type="text" class="form-control descripcion" readonly /></td>
                        <td><input id="cantidad" name="Detalles[0].Cantidad" placeholder="0" type="number" class="form-control cantidad" required /></td>
                        <td><input id="precio" name="Detalles[0].PrecioUnitario" placeholder="0" type="number" class="form-control precio" readonly /></td>
                        <td><input id="total" name="Detalles[0].Total" placeholder="0" type="number" class="form-control total" readonly /></td>
                    </tr>
                </tbody>
            </table>
            <div class="col">
                <button type="button" id="agregarfila" class="btn btn-danger">Nueva fila</button>
                <input type="submit" id="crear" class="btn btn-primary" placeholder="Crear Factura" onclick="CrearFactura()" />
                <h6>Total</h6>
                <input type="text" id="totalFactura" placeholder="0" class="form-control" readonly />
            </div>
            <hr />
                <footer style="text-align: center">
                    <p>El monto de la factura no incluye el impuesto sobre las ventas.</p>
                </footer>
    </body>
    <script>
        $(document).ready(function() {
           console.log('dentro de document.ready');

           var fechaActual = new Date();
           var formattedDate = fechaActual.toISOString().split('T')[0];
           //Establecer fecha actual en el campo fechaRegistro
           $("#fechaRegistro").val(formattedDate);

            // Realizar una solicitud AJAX para obtener el número de factura más reciente
           $.ajax({
                url: "https://localhost:44390/api/factura/invoices",
                type: "GET",
                dataType: "json",
                success: function(data) {
                    console.log("DATA INVOICES", data, data.length);
                    if (data.length > 0) {
                        // Incrementar el número de factura en uno y establecerlo en el campo "idCabecera"
                        var nf = data.length + 4;
                        $("#idCabecera").val(nf);
                    } else {
                        var numeroFactura = 1;
                        $("#idCabecera").val(numeroFactura);
                    }
                },
                error: function(error) {
                    console.error("Error al obtener el número de factura: " + error);
                }
            });

           $.ajax({
            url: "https://localhost:44390/api/factura/products",
            type: "GET",
            dataType: "json",
            success: function(data) {
                console.log("DATA", data);
                //Llena el elemento <select> con los productos
                    var select = $("#producto");
                    $.each(data, function(index, product){
                        select.append($("<option>").val(product.CodigoProducto).text(product.DescripcionProducto));
                    });

                // Agregar evento change al select del producto
                $(document).on("change", ".producto", function() {
                    var selectedCode = $(this).val();
                    var row = $(this).closest('.fila-detalle');
                    var descripcionInput = row.find('.descripcion');
                    var precioInput = row.find('.precio');
                    var selectedProduct = data.find(function(product) {
                        return product.CodigoProducto === selectedCode;
                    });
                    if (selectedProduct) {
                        descripcionInput.val(selectedProduct.DescripcionProducto);
                        precioInput.val(selectedProduct.PrecioUnitario);
                    } else {
                        descripcionInput.val('');
                        precioInput.val('');
                    }
                    calcularFilaTotal(row);
                    CalcularTotalDocumento();
                });
            },
            error: function(error) {
                console.error("Error al obtener la lista de productos: " + error);
            }
           });

           // Agregar evento input al campo cantidad
            $(document).on('input', '.cantidad', function() {
                var row = $(this).closest('.fila-detalle');
                calcularFilaTotal(row);
                CalcularTotalDocumento();
            });
        });

        function calcularFilaTotal(row) {
            var cantidad = parseFloat(row.find('.cantidad').val()) || 0;
            var precio = parseFloat(row.find('.precio').val()) || 0;
            var total = cantidad * precio;
            row.find('.total').val(total);
        }

        function CalcularTotalDocumento() {
            var filas = $("#tabla-detalle tbody tr");
            var totalDocumento = 0;
            filas.each(function() {
                var cantidad = parseFloat($(this).find(".cantidad").val()) || 0;
                var precio = parseFloat($(this).find(".precio").val()) || 0;
                totalDocumento += cantidad * precio;
            });
            $("#totalFactura").val(totalDocumento);
        }

        function ValidarYCrearFactura() {
        if (ValidarFormulario()) {
            CrearFactura();
        } else {
            alert("Por favor, complete todos los campos obligatorios.");
        }
    }

    function ValidarFormulario() {
        var camposRequeridos = [
            "NombreCliente", "NombreEmpresa", "DireccionEmpresa", "TelEmpresa",
            "NombreClienteEnvio", "NombreEmpresaEnvio", "DireccionEmpresaEnvio", "TelEmpresaEnvio",
            "NombreVendedor", "OrdenCompra", "EnviarPor", "TerminosCondiciones", "Vencimiento"
        ];

        for (var i = 0; i < camposRequeridos.length; i++) {
            var campoId = camposRequeridos[i];
            var campoValor = $("#" + campoId).val();
            if (campoValor.trim() === "") {
                return false;
            }
        }

        // Validar las filas de detalles
        var filasDetalle = $("#tabla-detalle tbody tr");
        for (var i = 0; i < filasDetalle.length; i++) {
            var fila = $(filasDetalle[i]);
            var cantidad = fila.find(".cantidad").val();
            if (cantidad.trim() === "") {
                return false;
            }
        }

        return true;
    }

        $(document).on("click", "#agregarfila", function() {
            // Clonar la primera fila y agregarla al final de la tabla
            var fila = $("#tabla-detalle tbody .fila-detalle:first").clone();
            fila.find("input[type='text'], input[type='number']").val('');
            $("#tabla-detalle tbody").append(fila);
        });
        function CrearFactura() {
            var facturaData = {
            NombreCliente: $("#NombreCliente").val(),
            NombreEmpresa: $("#NombreEmpresa").val(),
            DireccionEmpresa: $("#DireccionEmpresa").val(),
            TelEmpresa: $("#TelEmpresa").val(),
            NombreClienteEnvio: $("#NombreClienteEnvio").val(),
            NombreEmpresaEnvio: $("#NombreEmpresaEnvio").val(),
            DireccionEmpresaEnvio: $("#DireccionEmpresaEnvio").val(),
            TelEmpresaEnvio: $("#TelEmpresaEnvio").val(),
            NombreVendedor: $("#NombreVendedor").val(),
            OrdenCompra: $("#OrdenCompra").val(),
            EnviarPor: $("#EnviarPor").val(),
            TerminosCondiciones: $("#TerminosCondiciones").val(),
            Vencimiento: $("#Vencimiento").val(),
            Invoice_Details: [
                {
                    CodigoProducto: $("#producto").val(), 
                    DescripcionProducto: $("#descripcion").val(),
                    Cantidad: $("#cantidad").val(), 
                    PrecioUnitario: $("#precio").val(),
                    Total: $("#total").val() 
                }]
        };
        console.log("FACTURADATA", facturaData);
        $.ajax({
            url: "https://localhost:44390/api/factura/invoices",
            type: "POST",
            dataType: "json",
            data: JSON.stringify(facturaData), // Convierte el objeto a JSON
            contentType: "application/json",
            success: function (response) {
                console.log("RESPONSE", response);
                if (response) {
                    alert("Factura creada con éxito");
                    window.location = "InvoiceRegister.html";
                } else {
                    alert("Error al crear la factura");
                }
            },
            error: function (error) {
                console.error("Error al registrar la factura: " + error);
            },
        });

        }


    </script>
</html>